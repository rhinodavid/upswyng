<script context="module">
  export async function preload({ params, query }, { user }) {
    const { categories } = await this.fetch("/api/categories").then(r =>
      r.json()
    );
    const { uncategorizedResources } =
      user && user.isAdmin
        ? await this.fetch("/api/resources/uncategorized").then(r => r.json())
        : { uncategorizedResources: null };
    const { draftResources } =
      user && user.isAdmin
        ? await this.fetch("/api/resources/drafts?include-deleted").then(r =>
            r.json()
          )
        : { draftResources: null };
    const { draftResources: draftsForUser } = user
      ? await this.fetch("/api/resources/drafts/mine", {
          credentials: "same-origin",
        }).then(r => r.json())
      : { draftResources: null };
    return {
      categories,
      draftResources,
      draftsForUser,
      uncategorizedResources,
      user,
    };
  }
</script>

<script>
  import ResourceSearch from "../../../components/ResourceSearch.svelte";
  import { goto, stores } from "@sapper/app";
  import { readFlashMessages } from "../../../utility/flashMessage.ts";

  const { session } = stores();
  const flashMessages = readFlashMessages(session);

  export let categories = null;
  export let draftResources = null;
  export let draftsForUser = []; // The pending drafts created by a user
  export let uncategorizedResources = null;
  export let user = null;
</script>

<svelte:head>
  <title>Resources</title>
</svelte:head>

<section class="section">
  <div class="container">
    {#each flashMessages as flashMessage}
      <div
        class="notification"
        class:is-success={flashMessage.type === 'success'}
        class:is-danger={flashMessage.type === 'error'}>
        {flashMessage.message}
      </div>
    {/each}
    <h1 class="title">Resources</h1>
    {#if user}
      <div class="content">
        <a href="/providers/resource/create" class="button is-large">
          <span class="icon is-large">
            <i class="fas fa-plus" />
          </span>
          <span>Create a New Resource</span>
        </a>
      </div>
    {:else}
      <div class="notification">
        <a href="/providers/login">Log in</a>
        to create a resource
      </div>
    {/if}

    <div class="content">
      {#if categories.length}
        <h2 class="subtitle">Categories</h2>
        <ul class="content">
          {#each categories as category}
            <li>
              <a href={`/providers/category/${category.stub}`}>
                {category.name}
              </a>
            </li>
          {/each}
        </ul>
      {:else}
        <div class="notification">No categories found.</div>
      {/if}
    </div>

    {#if user && user.isAdmin}
      <div class="content">
        <h2 class="subtitle">
          Draft Resources
          <span class="tag is-dark">Admin</span>
        </h2>
        {#if draftResources.length}
          <ul class="content">
            {#each draftResources as draftResource}
              <li>
                <a href={`/providers/resource/draft/${draftResource._id}`}>
                  {draftResource.name}
                </a>
              </li>
            {/each}
          </ul>
        {:else}
          <div class="notification">No drafts at this time.</div>
        {/if}
      </div>
    {/if}

    {#if draftsForUser.length}
      <div class="content">
        <h2 class="subtitle">Your Drafts</h2>
        <ul class="content">
          {#each draftsForUser as draft}
            <li>
              <a href={`/providers/resource/draft/${draft._id}`}>
                {draft.name}
              </a>
            </li>
          {/each}
        </ul>
      </div>
    {/if}

    <div class="content">
      <h2 class="subtitle">Search for a Resource</h2>
      <ResourceSearch
        action="view"
        on:resourceClick={({ detail: resourceId }) => {
          goto(`/providers/resource/${resourceId}`);
        }} />
    </div>

    {#if uncategorizedResources.length && user && user.isAdmin}
      <div class="content">
        <h2 class="subtitle">
          Uncategorized Resources
          <span class="tag is-dark">Admin</span>
        </h2>
        <ul class="content">
          {#each uncategorizedResources as resource}
            <li>
              <a href={`/providers/resource/${resource.resourceId}`}>
                {resource.name}
              </a>
            </li>
          {/each}
        </ul>
      </div>
    {/if}
  </div>
</section>
